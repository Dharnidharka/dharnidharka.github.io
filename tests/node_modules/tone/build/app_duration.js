var midiPart, notes_arr;
var player = {}, genre = "TECHNO", track_change_flag = 0, tempPlayer = {}, tempMidi, bpm = 120;
var midi, json;
var url, base_dir;
var map, track, stopTime = 0;
var buffer;

var baseVolumeMap = {
  '60': 0,
  '62': 0,
  '64': 0,
  '65': 0,
  '67': 0,
  '69': 0,
  '71': 0,
  '72': 0,
};

var volumeMap = {
  '60': 0,
  '62': 0,
  '64': 0,
  '65': 0,
  '67': 0,
  '69': 0,
  '71': 0,
  '72': 0,
};

  //comment this line for client
  getMubert({
    genre: "TECHNO",
    bpm: "120",
    tone: "C",
    scale: "minor",
    app: "afp"
  });

  var limiter = new Tone.Limiter(-6).toMaster();
  var vol = new Tone.Volume(-24).connect(limiter);    //change this to -24, -12 and 0
  var cheby = new Tone.Chebyshev(10).connect(vol);
  var comp = new Tone.Compressor(-30, 3).connect(cheby);
  var filter3 = new Tone.Filter(200, "highpass").connect(comp);
  var filter2 = new Tone.Filter(200, "highpass").connect(filter3);
  var filter1 = new Tone.Filter(200, "highpass").connect(filter2);

  function getMubert(params){
    genre = params.genre;
    bpm = params.bpm;
    init();
  }

  function init(){
    addBuffering();
    getMidi();
    getNotes();
    setVolumeMap();
    removeBuffering();
  }


  function addBuffering(){
    $('#bufferContent').removeClass('hidden');
  }

  function removeBuffering(){
    $('#bufferContent').addClass('hidden');
  }

  function setVolumeMap(){
    for(str in player){
      if(str in volumeMap){
        player[str].mute = false;
      }
    }
    for(str in baseVolumeMap){
      volumeMap[str] = baseVolumeMap[str];
    }
  }

  function getMidi(){
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "https://pro.mubert.com/api", false);
    var params = '{ "method": "Music", "params":[{"APP":"AFP"},{"BPM":"120.00"},{"TONE":"C"},{"SCALE":"MINOR"},{"GENRE":"'+ genre + '"}], "dt": "web", "app": "afp" }';
    xhr.send(params);
    json = JSON.parse(xhr.response);
    midi = json.data.midi;
  }

  function getNotes(){
    samples = json.data.samples;
    player = new Tone.MultiPlayer(samples,
              function(){
                  alert('loaded');
                  playMidi(midi);
                  Tone.Transport.start('4n');
                  player.connect(cheby);
              }
          );

  }

  function getTempMidi(){
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "https://pro.mubert.com/api", false);
    var params = '{ "method": "Music", "params":[{"APP":"AFP"},{"BPM":"120.00"},{"TONE":"C"},{"SCALE":"MINOR"},{"GENRE":"'+ genre + '"}], "dt": "web", "app": "afp" }';
    xhr.send(params);
    json = JSON.parse(xhr.response);
    tempMidi = json.data.midi;
  }

  function getTempNotes(){
    samples = json.data.samples;
    for(var sample in samples){
      tempPlayer[sample] = new Tone.Player({
                "url" : samples[sample],
                "loop" : false
        });
    }
  }

function changeTrack(){
  track_change_flag = 0;
  midi = tempMidi;
  player = tempPlayer;
  console.log('changeTrack');
  $('.item').removeClass("muted");
  $('.genre').removeClass("quadrat");
  playMidi(midi);
}

function playMidi(file) {
  MidiConvert.load(file, function(midi) {
    // make sure you set the tempo before you schedule the events
    Tone.Transport.bpm.value = midi.header.bpm;
    midiPart = new Tone.Part(function(time, note) {
      console.log(time, note);
    var str = note.midi + '';
    if(player.buffers.has(str)){
      player.start(str, time, 0, note.duration);
    }

  }, midi.tracks[0].notes).start(stopTime);
    midiPart.loopStart = stopTime;
    stopTime += midi.duration;
    midiPart.loop = true;
    midiPart.loopEnd = midi.duration;
    Tone.Transport.bpm.value = bpm;
    Tone.Transport.schedule(function(time){
      changeTrack();
    }, stopTime);
  });
}
  $(document).ready(function(){
      $('.item').on('click', function(){
          var id = this.id;
          if($(this).hasClass("muted")){
            $(this).removeClass("muted");
            volumeMap[id] = 0;
            if(id in player){
              player[id].mute = false;
            }
          }
          else{
            $(this).addClass("muted");
            volumeMap[id] = -100;
            if(id in player){
              player[id].mute = true;
            }
          }
      });

      $('.genre').on('click', function(){
          var id = this.id;
          genre = id;
          $('.genre').removeClass("quadrat");
          $(this).addClass("quadrat");
          track_change_flag = 1;
          getTempMidi();
          getTempNotes();
          changeTrack();
      });

  });
